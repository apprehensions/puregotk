// Package {{.PkgName}} was automatically generated by github.com/jwijenbergh/puregotk DO NOT EDIT
package {{.PkgName}}

{{ $NotGObject := ne .PkgName "gobject" }}

{{if or .Imports .NeedsInit}}
import (
       {{if .NeedsInit}}
       "github.com/jwijenbergh/purego"
       "github.com/jwijenbergh/puregotk/internal/core"
       {{end}}
       {{range .Imports -}}
       "github.com/jwijenbergh/puregotk/v4/{{.}}"
       {{end}}
)
{{end}}

{{$outer := .}}

{{range .Callbacks -}}
{{.Doc}}
type {{.Name}} func({{ conv .Args.Pure.Types }}) {{.Ret.Raw}}
{{end}}

{{range .Records -}}
{{.Doc}}
type {{.Name}} struct {
     {{range .Fields}}
     {{.Name}} {{.Type}}
     {{end}}
}
{{end}}

{{range .Interfaces -}}
{{.Doc}}
type {{.Name}} interface {
     GoPointer() uintptr
     SetGoPointer(uintptr)
     {{range .Methods -}}
     {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}}
     {{end}}
}
type {{.Name}}Base struct {
     Ptr uintptr
}

func (x *{{.Name}}Base) GoPointer() uintptr {
     return x.Ptr
}

func (x *{{.Name}}Base) SetGoPointer(ptr uintptr) {
     x.Ptr = ptr
}

{{$outer := .}}
{{range .Methods -}}
{{.Doc}}
func (x *{{$outer.Name}}Base) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}} {
     {{if .Ret.Class}}
     {{.Name}}Ptr := {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     if {{.Name}}Ptr == 0 {
     	return nil
     }
     {{if .Ret.RefSink}}
     {{if $NotGObject}}gobject.{{end}}IncreaseRef({{.Name}}Ptr)
     {{end}}
     {{.Name}}Cls := {{.Ret.Instance}}{}
     {{.Name}}Cls.Ptr = {{.Name}}Ptr
     return {{.Name}}Cls
     {{else if .Ret.Value}}
     return {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     {{else}}
     {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     {{end}}
}
{{end}}

{{range .Methods -}}
var {{.Namespace}}X{{.FullName}} func(uintptr {{convc .Args.Pure.Types}}) {{.Ret.Raw}}
{{end}}
{{end}}

{{range .Aliases -}}
{{.Doc}}
type {{.Name}} = {{.Value}}
{{end}}

{{range .Enums -}}
{{.Doc}}
type {{.Name}} int
const (
{{$outer := .}}
{{range .Values -}}
	{{.Doc}}
	{{.Name}} {{$outer.Name}} = {{.Value}}
{{end}}
)
{{end}}

{{range .Functions -}}
var x{{.Name}} func({{conv .Args.Pure.Types}}) {{.Ret.Raw}}

{{.Doc}}
func {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}} {
     {{if .Ret.Class}}
     {{.Name}}Ptr := x{{.Name}}({{conv .Args.API.Call}})
     if {{.Name}}Ptr == 0 {
     	return nil
     }
     {{if .Ret.RefSink}}
     {{if $NotGObject}}gobject.{{end}}IncreaseRef({{.Name}}Ptr)
     {{end}}
     {{.Name}}Cls := {{.Ret.Instance}}{}
     {{.Name}}Cls.Ptr = {{.Name}}Ptr
     return {{.Name}}Cls
     {{else if .Ret.Value}}
     return x{{.Name}}({{conv .Args.API.Call}})
     {{else}}
     x{{.Name}}({{conv .Args.API.Call}})
     {{end}}
}
{{end}}

{{range .Classes -}}
{{.Doc}}
type {{.Name}} struct {
     {{.Parent}}
     {{if not .Parent}}
     Ptr uintptr
     {{end}}
}

{{$outer := .}}
func {{.Name}}NewFromInternalPtr(ptr uintptr) *{{.Name}} {
     cls := &{{.Name}}{}
     cls.Ptr = ptr
     return cls
}

{{range .Constructors -}}
var x{{.Name}}{{$outer.Name}} func({{conv .Args.Pure.Types}}) {{.Ret.Raw}}


{{.Doc}}
func {{.Name}}{{$outer.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}} {
     {{.Name}}{{$outer.Name}}Ptr := x{{.Name}}{{$outer.Name}}({{conv .Args.API.Call}})
     if {{.Name}}{{$outer.Name}}Ptr == 0 {
     	return nil
     }
     {{if .Ret.RefSink}}
     {{if $NotGObject}}gobject.{{end}}IncreaseRef({{.Name}}{{$outer.Name}}Ptr)
     {{end}}
     {{.Name}}{{$outer.Name}}Cls := {{.Ret.Instance}}{}
     {{.Name}}{{$outer.Name}}Cls.Ptr = {{.Name}}{{$outer.Name}}Ptr
     return {{.Name}}{{$outer.Name}}Cls
}
{{end}}

{{$outer := .}}
{{range .Receivers -}}
var x{{$outer.Name}}{{.Name}} func(uintptr {{convc .Args.Pure.Types}}) {{.Ret.Raw}}

{{.Doc}}
func (x *{{$outer.Name}}) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}} {
     {{if .Ret.Class}}
     {{.Name}}Ptr := x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convc .Args.API.Call}})
     if {{.Name}}Ptr == 0 {
     	return nil
     }
     {{if .Ret.RefSink}}
     {{if $NotGObject}}gobject.{{end}}IncreaseRef({{.Name}}Ptr)
     {{end}}
     {{.Name}}Cls := {{.Ret.Instance}}{}
     {{.Name}}Cls.Ptr = {{.Name}}Ptr
     return {{.Name}}Cls
     {{else if .Ret.Value}}
     return x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convc .Args.API.Call}})
     {{else}}
     x{{$outer.Name}}{{.Name}}(x.GoPointer() {{convc .Args.API.Call}})
     {{end}}
}
{{end}}

func (c *{{.Name}}) GoPointer() uintptr {
     return c.Ptr
}

func (c *{{.Name}}) SetGoPointer(ptr uintptr) {
     c.Ptr = ptr
}

{{range .Signals -}}

{{.Doc}}
func (x *{{$outer.Name}}) Connect{{.Name}}(cb func({{$outer.Name}} {{convc .Args.API.Types}}) {{.Ret.Value}}) {
     fcb := func(clsPtr uintptr {{convc .Args.Pure.Full}}) {{.Ret.Raw}} {
         fa := {{$outer.Name}}{}
         fa.Ptr = clsPtr
         {{if .Ret.Class}}
         {{.Name}}Cls := cb(fa {{convc .Args.Pure.Call}})
         return {{.Name}}Cls.Ptr
         {{else if .Ret.Value}}
         return cb(fa {{convc .Args.Pure.Call}})
         {{else}}
         cb(fa {{convc .Args.Pure.Call}})
         {{end}}
     }
     {{if $NotGObject}}gobject.{{end}}ObjectConnect(x.GoPointer(), "signal::{{.CName}}", purego.NewCallback(fcb))
}
{{end}}

{{range .Interfaces -}}
{{range .Methods -}}
{{.Doc}}
func (x *{{$outer.Name}}) {{.Name}}({{conv .Args.API.Full}}) {{.Ret.Value}} {
     {{if .Ret.Class}}
     {{.Name}}Ptr := {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     if {{.Name}}Ptr == 0 {
     	return nil
     }
     {{if .Ret.RefSink}}
     {{if $NotGObject}}gobject.{{end}}IncreaseRef({{.Name}}Ptr)
     {{end}}
     {{.Name}}Cls := {{.Ret.Instance}}{}
     {{.Name}}Cls.Ptr = {{.Name}}Ptr
     return {{.Name}}Cls
     {{else if .Ret.Value}}
     return {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     {{else}}
     {{.Namespace}}X{{.FullName}}(x.GoPointer() {{convc .Args.API.Call}})
     {{end}}
}
{{end}}
{{end}}

{{end}}


{{if .NeedsInit}}

func init() {
    lib, err := purego.Dlopen(core.GetPath("{{.PkgEnv}}"), purego.RTLD_NOW|purego.RTLD_GLOBAL)
    if err != nil {
            panic(err)
    }
    {{range .Functions -}}
    core.PuregoSafeRegister(&x{{.Name}}, lib, "{{.CName}}")
    {{end}}
    {{range .Classes -}}
    {{$cls := .}}
    {{range .Constructors -}}
    core.PuregoSafeRegister(&x{{.Name}}{{$cls.Name}}, lib, "{{.CName}}")
    {{end}}
    {{range .Receivers -}}
    core.PuregoSafeRegister(&x{{$cls.Name}}{{.Name}}, lib, "{{.CName}}")
    {{end}}
    {{end}}
    {{range .Interfaces -}}
    {{range .Methods -}}
    core.PuregoSafeRegister(&{{.Namespace}}X{{.FullName}}, lib, "{{.CName}}")
    {{end}}
    {{end}}
}
{{end}}
